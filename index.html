<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ³•å­¦æ–‡çŒ®å¼•æ³¨è½¬æ¢å·¥å…· V29.0 </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
        }

        .font-song {
            font-family: "SimSun", "Songti SC", serif;
        }

        .xtu-preview {
            font-family: "FangSong", "STFangsong", serif;
            font-size: 14px;
            line-height: 1.6;
        }

        .clsci-preview {
            font-family: "SimSun", "Songti SC", serif;
            font-size: 14px;
            line-height: 1.5;
        }

        .editable-output {
            cursor: text;
            transition: all 0.2s;
        }

        .editable-output:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
            background-color: #ffffff;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800 min-h-screen p-4 md:p-8">

    <div class="max-w-7xl mx-auto space-y-6">

        <!-- å¤´éƒ¨ -->
        <div class="bg-gray-900 p-6 rounded-2xl text-white shadow-xl relative overflow-hidden">
            <h1 class="text-2xl font-bold flex items-center gap-3 relative z-10">
                âš–ï¸ æ³•å­¦æ–‡çŒ®å¼•æ³¨è½¬æ¢å·¥å…· <span class="text-xs bg-green-500 text-white px-2 py-1 rounded-full font-bold">V29.0
                </span>
            </h1>
            <p class="text-gray-300 text-sm mt-2 relative z-10">
                ä»…æ”¯æŒçŸ¥ç½‘GB/T 7714-2015æ ¼å¼å¼•æ–‡ï¼Œæœ‰bugè¯·åé¦ˆç»™æººæ°´å°åˆ€ã€‚
            </p>
        </div>
        <div class="text-sm text-gray-500">
            <p>ä½¿ç”¨è¯´æ˜ï¼š
                1. é€‰æ‹©ç›®æ ‡æ ¼å¼æ ‡å‡†ã€‚
                2. ç²˜è´´å¾…è½¬æ¢çš„æ–‡çŒ®åˆ—è¡¨åˆ°å·¦ä¾§æ–‡æœ¬æ¡†ã€‚
                3. è½¬æ¢ç»“æœä¼šè‡ªåŠ¨æ˜¾ç¤ºåœ¨å³ä¾§æ–‡æœ¬æ¡†ï¼Œæ‚¨å¯ä»¥ç›´æ¥ç¼–è¾‘ç»“æœã€‚
                4. æ”¯æŒè‡ªå®šä¹‰å¼•æ³¨æ ¼å¼ã€‚
            </p>
            <br>
            <!-- æ ¸å¿ƒæ§åˆ¶åŒº -->
            <div class="bg-white p-6 rounded-xl shadow-md border border-slate-200">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div>
                        <h2 class="text-lg font-bold text-slate-700 flex items-center gap-2">
                            <span
                                class="bg-slate-700 text-white w-6 h-6 rounded-full flex items-center justify-center text-sm">1</span>
                            é€‰æ‹©ç›®æ ‡æ ¼å¼æ ‡å‡†
                        </h2>
                    </div>

                    <div class="flex bg-slate-100 p-1 rounded-lg">
                        <button onclick="changeStyle('clsci')" id="btn-clsci"
                            class="px-4 py-2 rounded-md text-sm font-medium transition-all text-slate-600 hover:bg-white hover:shadow-sm">
                            ä¸­å›½æ³•å­¦å¼•æ³¨æ ¼å¼
                        </button>
                        <button onclick="changeStyle('xtu')" id="btn-xtu"
                            class="px-4 py-2 rounded-md text-sm font-medium transition-all text-slate-600 hover:bg-white hover:shadow-sm">
                            æ¹˜å¤§ç ”ç©¶ç”Ÿå¼•æ³¨æ ¼å¼
                        </button>
                        <button onclick="changeStyle('custom')" id="btn-custom"
                            class="px-4 py-2 rounded-md text-sm font-medium transition-all text-slate-600 hover:bg-white hover:shadow-sm">
                            è‡ªå®šä¹‰å¼•æ³¨æ ¼å¼ (æ‰‹åŠ¨ç¼–è¾‘)
                        </button>
                    </div>
                </div>

                <!-- ç±»å‹é€‰æ‹©å™¨ (ä»…è‡ªå®šä¹‰æ¨¡å¼å¯è§) -->
                <div id="type-selector-box"
                    class="hidden mt-6 bg-gray-50 border border-gray-200 rounded-lg p-4 transition-all">
                    <div class="flex flex-col md:flex-row gap-6">
                        <div class="w-full md:w-1/3">
                            <h3 class="text-sm font-bold text-gray-900 mb-3">A. é€‰æ‹©è¦å¤„ç†çš„æ–‡çŒ®ç±»å‹ (å¼ºåˆ¶)ï¼š</h3>
                            <div class="flex flex-wrap gap-2">
                                <label class="cursor-pointer block w-full"><input type="radio" name="forcedType"
                                        value="J" class="peer sr-only" checked onchange="updateEditor()">
                                    <div
                                        class="px-3 py-2 rounded border border-gray-300 bg-white text-gray-600 peer-checked:bg-gray-800 peer-checked:text-white font-bold text-sm text-center transition">
                                        ğŸ“„ æœŸåˆŠ [J]</div>
                                </label>
                                <label class="cursor-pointer block w-full"><input type="radio" name="forcedType"
                                        value="M" class="peer sr-only" onchange="updateEditor()">
                                    <div
                                        class="px-3 py-2 rounded border border-gray-300 bg-white text-gray-600 peer-checked:bg-gray-800 peer-checked:text-white font-bold text-sm text-center transition">
                                        ğŸ“˜ å›¾ä¹¦ [M]</div>
                                </label>
                                <label class="cursor-pointer block w-full"><input type="radio" name="forcedType"
                                        value="D" class="peer sr-only" onchange="updateEditor()">
                                    <div
                                        class="px-3 py-2 rounded border border-gray-300 bg-white text-gray-600 peer-checked:bg-gray-800 peer-checked:text-white font-bold text-sm text-center transition">
                                        ğŸ“ å­¦ä½ [D]</div>
                                </label>
                                <label class="cursor-pointer block w-full"><input type="radio" name="forcedType"
                                        value="W" class="peer sr-only" onchange="updateEditor()">
                                    <div
                                        class="px-3 py-2 rounded border border-gray-300 bg-white text-gray-600 peer-checked:bg-gray-800 peer-checked:text-white font-bold text-sm text-center transition">
                                        ğŸŒ ç½‘ç»œ [W]</div>
                                </label>
                                <label class="cursor-pointer block w-full"><input type="radio" name="forcedType"
                                        value="C" class="peer sr-only" onchange="updateEditor()">
                                    <div
                                        class="px-3 py-2 rounded border border-gray-300 bg-white text-gray-600 peer-checked:bg-gray-800 peer-checked:text-white font-bold text-sm text-center transition">
                                        âš–ï¸ æ¡ˆä¾‹ [C]</div>
                                </label>
                                <label class="cursor-pointer block w-full"><input type="radio" name="forcedType"
                                        value="N" class="peer sr-only" onchange="updateEditor()">
                                    <div
                                        class="px-3 py-2 rounded border border-gray-300 bg-white text-gray-600 peer-checked:bg-gray-800 peer-checked:text-white font-bold text-sm text-center transition">
                                        ğŸ“° æŠ¥çº¸ [N]</div>
                                </label>
                                <label class="cursor-pointer block w-full"><input type="radio" name="forcedType"
                                        value="E" class="peer sr-only" onchange="updateEditor()">
                                    <div
                                        class="px-3 py-2 rounded border border-gray-300 bg-white text-gray-600 peer-checked:bg-gray-800 peer-checked:text-white font-bold text-sm text-center transition">
                                        ğŸ”¤ è‹±æ–‡ [E]</div>
                                </label>
                            </div>
                        </div>

                        <div class="flex-1 border-l border-gray-200 pl-6">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-sm font-bold text-gray-900">B. ç¼–è¾‘è¯¥ç±»å‹çš„æ¨¡æ¿ä»£ç ï¼š</h3>
                                <button onclick="resetCustomTemplates()"
                                    class="text-xs text-slate-400 hover:text-red-500 underline">æ¢å¤é»˜è®¤</button>
                            </div>
                            <input type="text" id="current-template-code"
                                class="w-full p-3 border border-gray-300 rounded font-mono text-sm bg-white focus:border-gray-800 focus:ring-1 focus:ring-gray-800 outline-none transition"
                                oninput="saveManualTemplate(this.value)">

                            <div class="mt-3 flex flex-wrap gap-2 text-[10px] text-slate-500">
                                <span
                                    class="bg-gray-100 px-2 py-1 rounded border border-gray-200 cursor-pointer hover:bg-gray-200"
                                    onclick="insertTag('{author}')">{author}ä½œè€…</span>
                                <span
                                    class="bg-gray-100 px-2 py-1 rounded border border-gray-200 cursor-pointer hover:bg-gray-200"
                                    onclick="insertTag('{title}')">{title}æ ‡é¢˜</span>
                                <span
                                    class="bg-gray-100 px-2 py-1 rounded border border-gray-200 cursor-pointer hover:bg-gray-200"
                                    onclick="insertTag('{journal}')">{journal}åˆŠå</span>
                                <span
                                    class="bg-gray-100 px-2 py-1 rounded border border-gray-200 cursor-pointer hover:bg-gray-200"
                                    onclick="insertTag('{year}')">{year}å¹´ä»½</span>
                                <span
                                    class="bg-gray-100 px-2 py-1 rounded border border-gray-200 cursor-pointer hover:bg-gray-200"
                                    onclick="insertTag('{issue}')">{issue}æœŸæ•°</span>
                                <span
                                    class="bg-gray-100 px-2 py-1 rounded border border-gray-200 cursor-pointer hover:bg-gray-200"
                                    onclick="insertTag('{pages}')">{pages}é¡µç </span>
                                <span
                                    class="bg-gray-100 px-2 py-1 rounded border border-gray-200 cursor-pointer hover:bg-gray-200"
                                    onclick="insertTag('{doi}')">{doi}DOI</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="preset-preview-box" class="mt-6 bg-slate-50 p-4 rounded-lg border border-slate-200">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">å½“å‰è§„åˆ™é¢„è§ˆ</span>
                        <span id="style-badge"
                            class="text-xs px-2 py-0.5 rounded bg-slate-200 text-slate-700 font-bold">ä¸­å›½æ³•å­¦</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2 text-xs font-mono text-slate-600">
                        <div><span class="text-blue-600 font-bold w-12 inline-block">æ–‡ç«  [J]:</span> <span
                                id="preview-J"></span></div>
                        <div><span class="text-blue-600 font-bold w-12 inline-block">å›¾ä¹¦ [M]:</span> <span
                                id="preview-M"></span></div>
                        <div><span class="text-blue-600 font-bold w-12 inline-block">ç½‘ç»œ [W]:</span> <span
                                id="preview-W"></span></div>
                        <div><span class="text-blue-600 font-bold w-12 inline-block">æ¡ˆä¾‹ [C]:</span> <span
                                id="preview-C"></span></div>
                    </div>
                </div>
            </div>

            <div class="grid lg:grid-cols-12 gap-6">

                <div class="lg:col-span-5 flex flex-col h-full">
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 flex-1 flex flex-col">
                        <h2 class="font-bold text-slate-700 mb-2 flex items-center gap-2">
                            <span
                                class="bg-slate-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-sm">2</span>
                            æ‰¹é‡å¤„ç†åŒºï¼šç²˜è´´å¾…è½¬æ¢æ–‡çŒ®ï¼ˆç²˜è´´æ–°æ–‡çŒ®è¯·å¦èµ·ä¸€è¡Œï¼‰
                        </h2>
                        <textarea id="inputArea"
                            class="w-full flex-1 min-h-[300px] p-4 border border-slate-300 rounded-lg font-mono text-sm bg-slate-50 focus:ring-2 focus:ring-slate-500 focus:border-slate-500 transition leading-relaxed"
                            placeholder="æµ‹è¯•æ··åˆè¾“å…¥ï¼š&#10;[1]å´æ€¡éœ.æˆéƒ½é«˜æ–°åŒºè¥¿å›­è¡—é“çºªæ£€ç›‘å¯Ÿå·¥å§”ï¼šç›‘ç£é˜µåœ°å»ºåˆ°å··å­é‡Œè¿å¿ƒæ¡¥é€šåˆ°å®¶é—¨å£[N].æˆéƒ½æ—¥æŠ¥,2025-12-10(007)."
                            oninput="processBatch()"></textarea>
                    </div>
                </div>

                <div class="lg:col-span-7 flex flex-col h-full">
                    <div
                        class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 flex-1 flex flex-col relative">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="font-bold text-slate-700 flex items-center gap-2">
                                <span
                                    class="bg-green-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-sm">3</span>
                                è½¬æ¢ç»“æœ (å¯ç¼–è¾‘)
                            </h2>
                            <div class="flex gap-2">
                                <span id="font-indicator"
                                    class="text-xs font-normal text-slate-400 border border-slate-200 px-2 py-1 rounded pt-1">å®‹ä½“</span>
                                <button onclick="copyResult()"
                                    class="bg-green-100 hover:bg-green-200 text-green-700 text-xs font-bold px-3 py-1 rounded border border-green-300 transition">
                                    å¤åˆ¶ç»“æœ
                                </button>
                            </div>
                        </div>
                        <textarea id="outputArea"
                            class="w-full flex-1 min-h-[300px] p-4 border border-green-200 rounded-lg bg-green-50 text-sm text-slate-900 leading-relaxed font-song editable-output focus:ring-2 focus:ring-green-500"
                            placeholder="ç»“æœå°†ç›´æ¥æ˜¾ç¤ºåœ¨è¿™é‡Œï¼Œæ‚¨å¯ä»¥ç›´æ¥ç‚¹å‡»æ­¤å¤„è¿›è¡Œä¿®æ”¹..."></textarea>
                    </div>
                </div>
            </div>

            <div class="text-center">
                <details class="text-xs text-slate-400 inline-block">
                    <summary class="cursor-pointer hover:text-slate-600">Debug Log</summary>
                    <div id="debugLog"
                        class="mt-2 p-3 bg-slate-800 text-green-400 rounded font-mono whitespace-pre-wrap h-32 w-[90vw] max-w-4xl mx-auto text-left overflow-y-auto">
                        Ready...</div>
                </details>
            </div>
        </div>

        <script>
            const PRESET_STYLES = {
                'clsci': {
                    name: 'ä¸­å›½æ³•å­¦',
                    cssClass: 'clsci-preview',
                    templates: {
                        'M': '[{index}]{author}ï¼šã€Š{title}ã€‹ï¼Œ{publisher}{year}å¹´ç‰ˆï¼Œç¬¬{pages}é¡µã€‚',
                        'J': '[{index}]{author}ï¼šã€Š{title}ã€‹ï¼Œè½½ã€Š{journal}ã€‹{year}å¹´ç¬¬{issue}æœŸï¼Œç¬¬{pages}é¡µã€‚',
                        'W': '[{index}]{author}ï¼šã€Š{title}ã€‹ï¼Œè½½{source}{date_cn_long}ï¼Œ{url}ã€‚',
                        'C': '[{index}]{title}ï¼Œ{source}ã€‚',
                        'A': '[{index}]{author}ï¼šã€Š{title}ã€‹ï¼Œ{conference}ä¼šè®®è®ºæ–‡ï¼Œ{year}å¹´ã€‚',
                        'D': '[{index}]{author}ï¼šã€Š{title}ã€‹ï¼Œ{publisher}{year}å¹´å­¦ä½è®ºæ–‡ï¼Œç¬¬{pages}é¡µã€‚',
                        'N': '[{index}]{author}ï¼šã€Š{title}ã€‹ï¼Œè½½ã€Š{source}ã€‹{year}å¹´{date_cn}ï¼Œç¬¬{pages}ç‰ˆã€‚',
                        'E': '[{index}]{author}, {title}, {volume} {journal} {pages} ({year}).'
                    }
                },
                'xtu': {
                    name: 'æ¹˜å¤§ç ”ç©¶ç”Ÿ',
                    cssClass: 'xtu-preview',
                    templates: {
                        'J': '[{index}]{author}ï¼šã€Š{title}ã€‹ï¼Œã€Š{journal}ã€‹{year}å¹´ç¬¬{issue}æœŸã€‚',
                        'M': '[{index}]{author}ï¼šã€Š{title}ã€‹ï¼Œ{publisher}ï¼Œ{year}å¹´ï¼Œç¬¬{pages}é¡µã€‚',
                        'T': '[{index}]{author}ï¼šã€Š{title}ã€‹ï¼Œ{translator}ï¼Œ{publisher}ï¼Œ{year}å¹´ï¼Œç¬¬{pages}é¡µã€‚',
                        'D': '[{index}]{author}ï¼šã€Š{title}ã€‹ï¼Œ{publisher}ï¼Œ{year}å¹´å­¦ä½è®ºæ–‡ã€‚',
                        'N': '[{index}]{author}ï¼šã€Š{title}ã€‹ï¼Œã€Š{source}ã€‹{year}å¹´{date_cn}ã€‚',
                        'W': '[{index}]{author}ï¼šã€Š{title}ã€‹ï¼Œ{source}{year}å¹´{date_cn}ï¼Œ{url}ã€‚',
                        'C': '[{index}]{title}ã€‚',
                        'A': '[{index}]{author}ï¼šã€Š{title}ã€‹ï¼Œ{conference}ä¼šè®®è®ºæ–‡ï¼Œ{year}å¹´ã€‚',
                        'E': '[{index}]{author}, {title}, {journal}, {year}, {pages}.'
                    }
                },
                'custom_default': {
                    name: 'è‡ªå®šä¹‰ (æ‰‹åŠ¨ç¼–è¾‘)',
                    cssClass: 'font-mono',
                    templates: {
                        'J': '{author}. {title}[J]. {journal}, {year}, {volume}({issue}): {pages}. {doi}',
                        'M': '{author}. {title}[M]. {publisher}, {year}.',
                        'W': '{author}. {title}[EB/OL]. {source}, {url}.',
                        'C': '{title}.',
                        'E': '{author}. {title}. {journal}, {year}.',
                        'N': '{author}. {title}[N]. {source}, {year}-{date}.',
                        'D': '{author}. {title}[D]. {publisher}, {year}.'
                    }
                }
            };

            function loadCustomTemplates() {
                try {
                    const saved = localStorage.getItem('userCustomTemplates');
                    return saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(PRESET_STYLES['custom_default'].templates));
                } catch (e) {
                    return JSON.parse(JSON.stringify(PRESET_STYLES['custom_default'].templates));
                }
            }

            function saveCustomTemplates(templates) {
                localStorage.setItem('userCustomTemplates', JSON.stringify(templates));
            }

            let currentStyleKey = 'clsci';
            let currentTemplates = JSON.parse(JSON.stringify(PRESET_STYLES['clsci'].templates));
            let userCustomTemplates = loadCustomTemplates();
            let lastInputLines = []; // è®°å½•ä¸Šæ¬¡è¾“å…¥çš„æ¯ä¸€è¡Œå†…å®¹

            function changeStyle(key) {
                currentStyleKey = key;
                const customBox = document.getElementById('type-selector-box');
                const previewBox = document.getElementById('preset-preview-box');

                if (key === 'custom') {
                    currentTemplates = userCustomTemplates;
                    if (customBox) customBox.classList.remove('hidden');
                    if (previewBox) previewBox.classList.add('hidden');
                    updateEditor();
                } else {
                    currentTemplates = JSON.parse(JSON.stringify(PRESET_STYLES[key].templates));
                    if (customBox) customBox.classList.add('hidden');
                    if (previewBox) previewBox.classList.remove('hidden');
                    updatePreview();
                }

                ['clsci', 'xtu', 'custom'].forEach(k => {
                    const btn = document.getElementById(`btn-${k}`);
                    if (btn) {
                        if (k === key) {
                            btn.classList.add('bg-slate-700', 'text-white', 'shadow-md');
                            btn.classList.remove('text-slate-600', 'hover:bg-white');
                        } else {
                            btn.classList.remove('bg-slate-700', 'text-white', 'shadow-md');
                            btn.classList.add('text-slate-600', 'hover:bg-white');
                        }
                    }
                });

                const fontInd = document.getElementById('font-indicator');
                if (fontInd) fontInd.innerText = key === 'xtu' ? 'ä»¿å®‹æ¨¡æ‹Ÿ' : 'å®‹ä½“';

                lastInputLines = []; // é‡ç½®è®°å½•
                processBatch(true); // åˆ‡æ¢æ ¼å¼æ—¶å¼ºåˆ¶åˆ·æ–°
            }

            function updatePreview() {
                ['J', 'M', 'W', 'N', 'C'].forEach(type => {
                    const el = document.getElementById(`preview-${type}`);
                    if (el) el.innerText = currentTemplates[type] || 'æš‚æ— ';
                });
            }

            function getForcedType() {
                const radios = document.getElementsByName('forcedType');
                for (let i = 0; i < radios.length; i++) {
                    if (radios[i].checked) return radios[i].value;
                }
                return 'J';
            }

            function updateEditor() {
                const type = getForcedType();
                const templateCodeInput = document.getElementById('current-template-code');
                templateCodeInput.value = currentTemplates[type] || '';
                lastInputLines = [];
                processBatch(true);
            }

            function saveManualTemplate(val) {
                const type = getForcedType();
                userCustomTemplates[type] = val;
                currentTemplates = userCustomTemplates;
                saveCustomTemplates(userCustomTemplates);
                lastInputLines = [];
                processBatch(true);
            }

            function insertTag(tag) {
                const input = document.getElementById('current-template-code');
                const start = input.selectionStart;
                const end = input.selectionEnd;
                const text = input.value;
                const before = text.substring(0, start);
                const after = text.substring(end, text.length);
                input.value = before + tag + after;
                input.selectionStart = input.selectionEnd = start + tag.length;
                input.focus();
                saveManualTemplate(input.value);
            }

            function resetCustomTemplates() {
                if (confirm("ç¡®å®šæ¢å¤é»˜è®¤è®¾ç½®ï¼Ÿ")) {
                    userCustomTemplates = JSON.parse(JSON.stringify(PRESET_STYLES['custom_default'].templates));
                    currentTemplates = userCustomTemplates;
                    saveCustomTemplates(userCustomTemplates);
                    updateEditor();
                    lastInputLines = [];
                    processBatch(true);
                }
            }

            function processBatch(forceRefresh = false) {
                const inputEl = document.getElementById('inputArea');
                const outputEl = document.getElementById('outputArea');
                if (!inputEl || !outputEl) return;

                const rawText = inputEl.value.trim();
                if (!rawText) {
                    outputEl.value = "";
                    lastInputLines = [];
                    return;
                }

                const lines = rawText.split('\n').filter(line => line.trim()).map(line => line.trim());
                const currentLineCount = lines.length;

                // è·å–å½“å‰è¾“å‡ºçš„è¡Œ
                const outputLines = outputEl.value.trim() ? outputEl.value.trim().split('\n') : [];

                // å¦‚æœæ˜¯å¼ºåˆ¶åˆ·æ–°ï¼ˆåˆ‡æ¢æ ¼å¼ç­‰ï¼‰ï¼Œé‡æ–°å¤„ç†æ‰€æœ‰å†…å®¹
                if (forceRefresh) {
                    let output = [];
                    const forcedType = currentStyleKey === 'custom' ? getForcedType() : null;

                    lines.forEach((line, idx) => {
                        if (!line) return;

                        const data = smartParse(line);
                        const type = forcedType ? forcedType : detectType(data, line);
                        data.index = idx + 1;

                        let template;
                        if (forcedType) {
                            template = currentTemplates[forcedType];
                        } else {
                            template = (data.isEnglish && currentTemplates['E']) ? currentTemplates['E'] : (currentTemplates[type] || currentTemplates['J']);
                        }

                        let formatted = fillTemplate(template, data);
                        output.push(formatted);
                    });

                    outputEl.value = output.join('\n');
                    lastInputLines = [...lines];
                    return;
                }

                // æ™ºèƒ½æ›´æ–°æ¨¡å¼ï¼šæ£€æµ‹å“ªäº›è¡Œå‘ç”Ÿäº†å˜åŒ–
                let newOutputLines = [...outputLines];
                let needUpdate = false;
                const forcedType = currentStyleKey === 'custom' ? getForcedType() : null;

                // æ£€æŸ¥æ¯ä¸€è¡Œæ˜¯å¦æœ‰å˜åŒ–
                for (let i = 0; i < currentLineCount; i++) {
                    const currentLine = lines[i];
                    const previousLine = lastInputLines[i] || '';

                    // å¦‚æœè¿™æ˜¯æ–°å¢çš„è¡Œï¼Œæˆ–è€…å†…å®¹å‘ç”Ÿäº†å˜åŒ–
                    if (i >= lastInputLines.length || currentLine !== previousLine) {
                        needUpdate = true;
                        const data = smartParse(currentLine);
                        const type = forcedType ? forcedType : detectType(data, currentLine);
                        data.index = i + 1;

                        let template;
                        if (forcedType) {
                            template = currentTemplates[forcedType];
                        } else {
                            template = (data.isEnglish && currentTemplates['E']) ? currentTemplates['E'] : (currentTemplates[type] || currentTemplates['J']);
                        }

                        let formatted = fillTemplate(template, data);
                        newOutputLines[i] = formatted;
                    }
                }

                // å¦‚æœè¡Œæ•°å‡å°‘äº†ï¼Œæˆªæ–­è¾“å‡º
                if (currentLineCount < lastInputLines.length) {
                    newOutputLines = newOutputLines.slice(0, currentLineCount);
                    needUpdate = true;
                }

                if (needUpdate) {
                    outputEl.value = newOutputLines.join('\n');
                }

                lastInputLines = [...lines];
            }

            function fillTemplate(tpl, data) {
                if (!tpl) return "ã€æœªå®šä¹‰æ¨¡æ¿ã€‘" + data.title;
                let res = tpl;

                res = res.replace(/{author}/g, data.author || "");
                res = res.replace(/{title}/g, data.title || "");
                res = res.replace(/{year}/g, data.year || "");
                res = res.replace(/{journal}/g, data.journal || data.source || "");
                res = res.replace(/{source}/g, data.source || data.journal || "");
                res = res.replace(/{publisher}/g, data.publisher || data.source || "");
                res = res.replace(/{url}/g, data.url || "");
                res = res.replace(/{issue}/g, data.issue || "");
                res = res.replace(/{pages}/g, data.pages || "");
                res = res.replace(/{index}/g, data.index);
                res = res.replace(/{volume}/g, data.volume || "");
                res = res.replace(/{date}/g, data.date || "");
                res = res.replace(/{date_cn}/g, data.date_cn || "");
                res = res.replace(/{date_cn_long}/g, data.date_cn_long || "");
                res = res.replace(/{doi}/g, data.doi || "");
                res = res.replace(/{conference}/g, data.conference || "");

                if (!data.author) res = res.replace(/ï¼š/, "").replace(/\[\d+\]ï¼š/, `[${data.index}]`);

                // ä¿®å¤ï¼šæŠ¥çº¸ç‰ˆæ¬¡å»å‰å¯¼é›¶ï¼Œä¾‹å¦‚ ç¬¬007ç‰ˆ -> ç¬¬7ç‰ˆ
                if (data.pages && /^\d+$/.test(data.pages)) {
                    const pageNum = parseInt(data.pages, 10);
                    if (!isNaN(pageNum)) {
                        res = res.replace(`ç¬¬${data.pages}ç‰ˆ`, `ç¬¬${pageNum}ç‰ˆ`);
                    }
                } else {
                    if (!data.pages) res = res.replace(/ç¬¬é¡µ/, "").replace(/ç¬¬\s*é¡µ/, "");
                }

                if (!data.issue) res = res.replace(/ç¬¬æœŸ/, "");
                if (!data.volume) res = res.replace(/,  /, ", ").trim();

                if (!data.isEnglish) {
                    res = res.replace(/ï¼Œï¼Œ/g, "ï¼Œ").replace(/ã€‚ã€‚/g, "ã€‚").replace(/ï¼Œã€‚/g, "ã€‚");
                    res = res.replace(/\(\)/g, "").replace(/ï¼ˆï¼‰/g, "");
                } else {
                    res = res.replace(/, ,/g, ",");
                }

                // æ¸…æ´—ï¼šé˜²æ­¢æŠ¥çº¸ååæœ‰å¤šä½™æ ‡ç‚¹
                res = res.replace(/ã€Š([^ã€‹]+)[ã€ï¼Œ,]\s*ã€‹/g, "ã€Š$1ã€‹");

                return res;
            }

            function smartParse(text) {
                let info = {
                    author: "", title: "", year: "", source: "", journal: "", publisher: "",
                    translator: "", volume: "", issue: "", pages: "", conference: "",
                    date: "", date_cn: "", date_cn_long: "", url: "", doi: "", isEnglish: false
                };

                text = text.trim().replace(/^\[\d+\]/, "").replace(/^\d+\./, "").trim();

                const engChars = (text.match(/[a-zA-Z]/g) || []).length;
                info.isEnglish = engChars > text.length * 0.3;

                let rawOriginal = text;
                let safeText = text.replace(/[ã€‚ï¼Œï¼š]/g, c => ({ 'ã€‚': '.', 'ï¼Œ': ',', 'ï¼š': ':' })[c]).replace(/[ï¼ˆï¼‰]/g, c => ({ 'ï¼ˆ': '(', 'ï¼‰': ')' })[c]);

                // 1. DOI / URL
                const doiMatch = safeText.match(/(https?:\/\/doi\.org\/[\w\.\/\-]+)/);
                if (doiMatch) {
                    info.doi = doiMatch[1];
                    info.url = doiMatch[1];
                    safeText = safeText.replace(doiMatch[1], "");
                } else {
                    const urlMatch = safeText.match(/(https?:\/\/[^\s,ï¼Œã€‚]+)/);
                    if (urlMatch) {
                        info.url = urlMatch[1];
                        safeText = safeText.replace(info.url, "");
                    }
                }

                // 2. å¹´ä»½ & æ—¥æœŸ
                const bracketDateMatch = safeText.match(/\[(\d{4}[\.\/\-]\d{1,2}[\.\/\-]\d{1,2})\]/);
                let fullDateStr = "";

                // *** V29.1 ä¿®å¤ï¼šå¤„ç†å›¾ä¹¦æ ¼å¼ å‡ºç‰ˆç¤¾:YYYYMM:é¡µç  ***
                const bookDatePageMatch = safeText.match(/å‡ºç‰ˆç¤¾:(\d{4})(\d{2}):(\d+)/);
                if (bookDatePageMatch) {
                    info.year = bookDatePageMatch[1]; // å¹´ä»½ YYYY
                    info.pages = bookDatePageMatch[3]; // é¡µç 
                    // æ¸…ç†åŸå§‹å­—ç¬¦ä¸²ä¸­çš„å¹´æœˆé¡µç éƒ¨åˆ†ï¼Œä¿ç•™å‡ºç‰ˆç¤¾
                    safeText = safeText.replace(/:(\d{4})(\d{2}):(\d+)/, "");
                } else if (bracketDateMatch) {
                    fullDateStr = bracketDateMatch[1];
                    safeText = safeText.replace(bracketDateMatch[0], "");
                } else {
                    const dateMatchLong = safeText.match(/(\d{4}[\.\/\-å¹´]\d{1,2}[\.\/\-æœˆ]\d{1,2}[æ—¥]?)/);
                    if (dateMatchLong && dateMatchLong[0].length > 4) {
                        fullDateStr = dateMatchLong[0];
                        safeText = safeText.replace(fullDateStr, "");
                    }
                }

                if (fullDateStr) {
                    info.date = fullDateStr;
                    let d = fullDateStr.replace(/[å¹´\.\/]/g, '-').replace(/æœˆ/g, '-').replace(/æ—¥/g, '');
                    let parts = d.split('-');
                    if (parts.length >= 3) {
                        let y = parseInt(parts[0]);
                        let m = parseInt(parts[1]);
                        let day = parseInt(parts[2]);
                        info.year = y.toString();
                        info.date_cn = `${m}æœˆ${day}æ—¥`;
                        info.date_cn_long = `${y}å¹´${m}æœˆ${day}æ—¥`;
                    }
                } else if (!info.year) {
                    const yearMatch = safeText.match(/(?:^|[\D])([12]\d{3})(?:[\D]|$)/);
                    if (yearMatch) info.year = yearMatch[1];
                }

                // 3. å·å· & æœŸå·
                const volIssueMatch = safeText.match(/(\d+)\(0?(\d+)\)/);
                const issueOnlyMatch = safeText.match(/\(0?(\d+)\)/) || safeText.match(/ç¬¬(\d+)æœŸ/);

                if (volIssueMatch) {
                    if (volIssueMatch[1] === info.year) {
                        info.issue = volIssueMatch[2];
                    } else {
                        info.volume = volIssueMatch[1];
                        info.issue = volIssueMatch[2];
                    }
                } else if (issueOnlyMatch) {
                    if (/^\d+$/.test(issueOnlyMatch[1])) info.issue = issueOnlyMatch[1];
                }

                // 4. é¡µç 
                const pageMatch = safeText.match(/(\d+[-\uff0d]\d+(?:[+,ï¼Œ]\d+)*)/) || safeText.match(/p\.?(\d+)/i) || safeText.match(/ç¬¬(\d+)é¡µ/);

                if (pageMatch) {
                    if (!/^20\d\d$/.test(pageMatch[1])) {
                        let rawPages = pageMatch[1];
                        if (rawPages.includes('+')) {
                            rawPages = rawPages.split('+')[0];
                        }
                        info.pages = rawPages;
                        info._rawPageString = pageMatch[1];
                    }
                }

                // *** V28 ä¿®å¤ï¼šæ›´å®½å®¹çš„ç‰ˆæ¬¡æ•è·ï¼Œæ”¯æŒç»“å°¾æœ‰æ ‡ç‚¹ ***
                if (!info.pages) {
                    // å°è¯•æ•è· (007) æˆ– (007).
                    const bracketPage = safeText.match(/\((\d+)\)[\.ã€‚]?$/);
                    if (bracketPage) {
                        info.pages = bracketPage[1];
                        info._rawPageString = bracketPage[0];
                    }
                }

                // 5. åˆ†å‰²
                if (info.isEnglish) {
                    const parts = rawOriginal.split(/[\.,]\s/);
                    if (parts.length > 0) info.author = parts[0];
                    if (parts.length > 1) info.title = parts[1];
                    if (parts.length > 2 && !parts[2].match(/^\d/)) info.journal = parts[2];
                    info.source = info.journal;
                    return info;
                }

                // *** ä¼šè®®è®ºæ–‡ [C]// æ ¼å¼è§£æ ***
                if (rawOriginal.includes('[C]//')) {
                    // æ ¼å¼: ä½œè€….æ ‡é¢˜[C]//ä¸»åŠå•ä½.ä¼šè®®åç§°è®ºæ–‡é›†.åœ°ç‚¹,å¹´ä»½:é¡µç .DOI
                    const cMatch = rawOriginal.match(/^([^.]+)\.([^[]+)\[C\]\/\/([^.]+)\.([^.]+)\./);
                    if (cMatch) {
                        info.author = cMatch[1].trim();
                        info.title = cMatch[2].trim();
                        // å°†ä¸»åŠå•ä½å’Œä¼šè®®åç§°åˆå¹¶ä¸ºä¼šè®®åç§°
                        let confName = cMatch[4].trim();
                        // å»æ‰"è®ºæ–‡é›†"ç­‰åç¼€
                        confName = confName.replace(/è®ºæ–‡é›†$/, '').trim();
                        info.conference = confName;
                    }
                    // å¹´ä»½å’Œé¡µç å·²ç»åœ¨å‰é¢æå–
                    return info;
                }

                if (rawOriginal.includes("æ¡ˆ")) {
                    const anIndex = rawOriginal.indexOf("æ¡ˆï¼Œ");
                    if (anIndex > -1) {
                        info.title = rawOriginal.substring(0, anIndex + 1);
                        info.source = rawOriginal.substring(anIndex + 2).replace(/ã€‚$/, "");
                        return info;
                    }
                }

                let cleanText = safeText.replace(/\[[A-Z\/]+\]/g, "");
                cleanText = cleanText.replace(/([^\d]),([^\d])/g, "$1ã€$2");

                let parts = cleanText.split('.').map(p => p.trim()).filter(p => p);

                if (rawOriginal.startsWith("ã€Š") || rawOriginal.startsWith("â€œ")) {
                    info.author = "";
                    const titleEnd = Math.max(rawOriginal.indexOf("ã€‹"), rawOriginal.indexOf("â€"));
                    if (titleEnd > -1) {
                        if (parts.length > 1 && parts[0].length < 15) {
                            info.author = parts[0];
                            info.title = parts[1];
                        } else {
                            info.title = rawOriginal.substring(0, titleEnd + 1);
                        }
                    } else {
                        info.title = parts[0];
                    }
                } else {
                    if (parts.length >= 1) info.author = parts[0];
                    if (parts.length >= 2) info.title = parts[1];
                }

                if (!info.source && parts.length > 2) {
                    let potentialSources = parts.slice(2).filter(p => p.length > 1 && !p.includes("è¯‘") && !p.match(/^[\d\s-]+$/));
                    if (potentialSources.length > 0) info.source = potentialSources[0];
                }

                // 6. æ·±åº¦æ¸…æ´—æ¥æº
                if (info.source) {
                    let s = info.source;
                    if (fullDateStr) s = s.replace(fullDateStr, "");
                    if (info.year) s = s.replace(info.year, "");

                    if (info.volume && info.issue) {
                        const regex = new RegExp(`${info.volume}\\(0?${info.issue}\\)`);
                        s = s.replace(regex, "");
                    }
                    if (info.issue) {
                        s = s.replace(new RegExp(`\\(0?${info.issue}\\)`), "").replace(new RegExp(`ç¬¬${info.issue}æœŸ`), "");
                    }
                    if (info._rawPageString) {
                        const escapedPages = info._rawPageString.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                        s = s.replace(new RegExp(escapedPages), "");
                    }

                    s = s.replace(/^[:ï¼š,ï¼Œ\-\/\s]+|[:ï¼š,ï¼Œ\-\/\s]+$/g, "").trim();
                    s = s.replace(/-\d+-/g, "");
                    s = s.replace(/\/\d+\//g, "");
                    if (s === "ã€" || s === "," || s === "ï¼Œ") s = "";

                    info.source = s;
                    if (s.includes("å‡ºç‰ˆç¤¾") || s.includes("Press")) info.publisher = s;
                    else info.journal = s;
                }

                return info;
            }

            function detectType(data, rawLine) {
                if (data.isEnglish) return 'E';
                // J/OL ä¼˜å…ˆè¯†åˆ«ä¸ºæœŸåˆŠï¼ˆç½‘ç»œé¦–å‘çš„æœŸåˆŠæ–‡ç« ï¼‰
                if (rawLine.includes('[J/OL]') || rawLine.includes('[J]')) return 'J';
                if (rawLine.includes('[M]')) return 'M';
                if (rawLine.includes('[D]')) return 'D';
                if (rawLine.includes('[N]')) return 'N';
                if (rawLine.includes('[W]') || rawLine.includes('[EB/OL]')) return 'W';
                // ä¼šè®®è®ºæ–‡ [C]// æ ¼å¼ï¼ŒåŒºåˆ†äºæ¡ˆä¾‹
                if (rawLine.includes('[C]//')) return 'A';
                if (rawLine.includes("æ¡ˆ")) return 'C';
                // åªæœ‰æ˜ç¡®çš„ç½‘ç»œæ–‡çŒ®æ‰è¯†åˆ«ä¸º Wï¼Œå¸¦ DOI çš„æœŸåˆŠä¸ç®—
                if (data.url && !data.doi) return 'W';

                if (data.source && data.source.includes("å‡ºç‰ˆç¤¾")) return 'M';
                return 'J';
            }

            function copyResult() {
                document.getElementById('outputArea').select();
                document.execCommand('copy');
                alert("å·²å¤åˆ¶ï¼");
            }

            function log(msg) {
                const logEl = document.getElementById('debugLog');
                if (logEl) logEl.innerText = `${msg}\n` + logEl.innerText;
            }

            window.onload = function () {
                changeStyle('clsci');
            }
        </script>
</body>

</html>
